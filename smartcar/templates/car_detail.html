{% load staticfiles %}
<script src="{% static 'js/jquery.js' %}"></script>
<script src="{% static 'js/car_information.js' %}"></script>
<link href="{% static 'css/map.css'%}" rel="stylesheet">

{% block contents %}

{% if user.is_authenticated %}
    {% else %}
        <script>
        window.location.href =  "{% url 'auth' %}";
        </script>
{% endif %}
    <div id="detail-side3">
        <span id="car_number" value="{{ carNumber }}">{{ carNumber }}번차량</span><br>
        차량번호:<span id="pi_id"></span><br>
        <!-- 경로 찾을때 input-->
        속도:<span id="car_speed"></span><br>
        도착시간:<span id="car_arrive_time"></span><br>
        거리:<span id="car_destination_distance"></span><br>
        현재상태:<span id="car_now_situation"></span><br>

        <!-- 차량 등록때 input-->
        배터리:<span id="battery"></span><br>
        통신상태:<span id="communication"></span><br>
        차량타입:<span id="car_type"></span><br>
        영상정보:<span id="picture"></span><br>

        <!-- 컨테이너 등록때 input-->
        <!--컨테이너번호:<span id="container_id"></span><br>-->
        컨테이너제조사:<span id="container_company"></span><br>
        컨테이너제품:<span id="container_product"></span><br>
        컨테이너출하일:<span id="container_shipment_day"></span><br>

        <!-- exam -->
        Container-id:<input type="text" id="container_id" />
        <button onclick="container()">컨테이너등록</button>

    </div>
      <br>
      <a href="/main">메인으로가기</a><br>
      <!-- 수동조작 틀-->
      <button id="manual" onclick="manual()">수동모드</button>
      <button id="auto" onclick="auto()">자동모드</button><br>
      <div id="control">
      <button id="go" onclick="go()">직진</button>
      <button id="back" onclick="back()">후진</button>
      <button id="right" onclick="right()">우회전</button>
      <button id="left" onclick="left()">좌회전</button>
      </div>


      <input type="hidden" id="for_container" value="{{ carNumber }}">
      <div id="map"></div>




<script>
$(document).ready(function(){
    $("#control").fadeOut("fast")
    var index = $("#for_container").val()
    route(index)
})
function manual(){
    $("#driving_mode").text('수동');
    $("#control").fadeIn("fast");
}
function auto(){
    $("#driving_mode").text('자동');
    $("#control").fadeOut('fast');
}
function go(){
    var a = '1 '
        $.ajax({
            type : 'POST',
            url : 'http://192.168.0.9:8000',
            dataType:'json',
            data : {
            'bbb': a
            },
            success: function(){
            }
        });
}
function back(){
    var a = '4 '
        $.ajax({
            type : 'POST',
            url : 'http://192.168.0.10:8000',
            dataType:'json',
            data : {
            'bbb': a
            },
            success: function(){
            }
        });
}
function right(){
    var a = '2 '
        $.ajax({
            type : 'POST',
            url : 'http://192.168.0.10:8000',
            dataType:'json',
            data : {
            'bbb': a
            },
            success: function(){
            }
        });
}
function left(){
    var a = '3 '
        $.ajax({
            type : 'POST',
            url : 'http://192.168.0.10:8000',
            dataType:'json',
            data : {
            'bbb': a
            },
            success: function(){
            }
        });
}
function sleep(num){
			 var now = new Date();
			 var stop = now.getTime() + num;
			 while(true){
	             now = new Date();
				 if(now.getTime() > stop)return;
			 }

}
    var filtered_json = new Array();
    $.ajax({
                 url : "http://127.0.0.1:8000/api/CarInfo/?format=json",
                 dataType : 'json',
                 success : function (data) {
                    var my_json = JSON.stringify(data)
                    filtered_json = find_in_object(JSON.parse(my_json), {id: {{ carNumber }} });
                    var pi_id = filtered_json[0].pi_id;
                    var container_id = filtered_json[0].container_id;
                    var car_name = filtered_json[0].car_name;
                    var car_speed = filtered_json[0].car_speed;
                    var car_arrived_time = filtered_json[0].car_arrived_time;
                    var car_destination_distance = filtered_json[0].car_destination_distance;
                    var car_now_situation = filtered_json[0].car_now_situation;
                    var car_speed = filtered_json[0].car_speed;

                    if(car_speed != null){
                        var car_arrive_time = filtered_json[0].car_arrive_time;
                        var car_now_situation = filtered_json[0].car_now_situation;
                        var car_destination_distance = filtered_json[0].car_destination_distance;
                        $("#car_speed").text(car_speed);
                        $("#car_arrive_time").text(car_arrive_time);
                        $("#car_now_situation").text(car_now_situation);
                        $("#car_destination_distance").text(car_destination_distance);
                    }

                    $("#pi_id").text(pi_id).val(pi_id);
                    $("#container_id").text(container_id).val(container_id);
                    $("#car_name").text(car_name);
                    $("#car_speed").text(car_speed);
                    $("#car_arrived_time").text(car_arrived_time);
                    $("#car_destination_distance").text(car_destination_distance);
                    $("#car_now_situation").text(car_now_situation);
                 }
      });
    sleep(30)
    $.ajax({
                 url : "http://127.0.0.1:8000/api/PiInfo/?format=json",
                 dataType : 'json',
                 success : function (data) {

                    var my_json = JSON.stringify(data)
                    var va = document.getElementById("pi_id").value;
                    filtered_json = find_in_object(JSON.parse(my_json), {pi_id: va});
                    var battery = filtered_json[0].battery;
                    var communication = filtered_json[0].communication;
                    var car_type = filtered_json[0].car_type;
                    var picture = filtered_json[0].picture;

                    $("#battery").text(battery);
                    $("#communication").text(communication);
                    $("#car_type").text(car_type);
                    $("#picture").text(picture);
                 }
    });
    sleep(30)
    $.ajax({
                 url : "http://127.0.0.1:8000/api/ContainerInfo/?format=json",
                 dataType : 'json',
                 success : function (data) {

                    var my_json = JSON.stringify(data)
                    var co = document.getElementById("container_id").value;
                    filtered_json = find_in_object(JSON.parse(my_json), {container_id: co});
                    if(filtered_json.length != 0){
                        var container_company = filtered_json[0].container_company;
                        var container_product = filtered_json[0].container_product;
                        var container_shipment_day = filtered_json[0].container_shipment_day;

                        $("#container_company").text(container_company);
                        $("#container_product").text(container_product);
                        $("#container_shipment_day").text(container_shipment_day);
                    }

                 }
    });



function find_in_object(my_object, my_criteria){
  return my_object.filter(function(obj) {
    return Object.keys(my_criteria).every(function(c) {
      return obj[c] == my_criteria[c];
    });
  });
}

function route(clicked_car){
    var car_route
    var count
    var car_route1 = new Array()
    var car_route2 = new Array()
         $.ajax({
                 url : "http://127.0.0.1:8000/api/CarInfo/?format=json",
                 dataType : 'json',
                 success : function (data) {
                    map(data[clicked_car-1].car_route, data[clicked_car-1].now_x, data[clicked_car-1].now_y, data[clicked_car-1].target_x, data[clicked_car-1].target_y)
                 }
         });
}
function map(route, x, y, a, b){
    var car_route1 = new Array()
    var car_route2 = new Array()
    car_route = route
    now_x = Number(x)
    now_y = Number(y)
    target_x = Number(a)
    target_y = Number(b)
    car_route1 = car_route.split(']')
    count = car_route1.length - 2
    for(var i = 0; i<=count; i++){
          car_route2[i] = new Array()
    }
    for(var i = 0; i<= count; i++){
          car_route2[i] = car_route1[i].split(', ')
    }
    for(var x = 0; x <= count; x++)
          for(var y = 0; y <= 1; y++){
               car_route2[x][y] = Number(car_route2[x][y])
    }
    var map_display;
    var map_array = new Array();
    var map_array2 = new Array();
    for(var i=0;i<=13;i++){
        map_array2[i] = new Array();
    }
     $.ajax({
                 url : "http://127.0.0.1:8000/api/MapInfo/?format=json",
                 dataType : 'json',
                 success : function(data){
                     map_display=data[1].map;
                     map_array=map_display.split('s');
                     for(var i=0; i<=13; i++){
                       map_array2[i]=map_array[i].split(', ');
                     }
                     for(var i=0; i<=count; i++){
                            map_array2[car_route2[i][0]][car_route2[i][1]]="4"
                     }
                     if( now_x != ''){
                            map_array2[now_x][now_y]="3"
                     }
                     if(car_route == ''){
                        if( target_x !=''){
                            map_array2[target_x][target_y]="5"
                        }
                     }
                     for(var i=0; i<=13; i++){
                         for(var j=0; j<=13; j++){
                            if(map_array2[i][j]==0){
                                 $("#map").append('<span id="route0"></span>');
                            }
                            else if(map_array2[i][j]==1){
                                 $("#map").append('<span id="route1"></span>');
                            }
                            else if(map_array2[i][j]==2){
                                 $("#map").append('<span id="route2"></span>');
                            }
                            else if(map_array2[i][j]==3){
                                 $("#map").append('<span id="route3"></span>');
                            }
                            else if(map_array2[i][j]==5){
                                 $("#map").append('<span id="route5"></span>');
                            }
                            else if(map_array2[i][j]==8){
                                 $("#map").append();
                            }
                            else if(map_array2[i][j]==4){
                                 $("#map").append('<span id="route4"></span>');
                            }
                         }
                         $("#map").append("<br>");
                     }
                 }
     });
}
</script>
{% endblock %}